<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSnessGYM API Interface</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
        h1 { color: #2c3e50; text-align: center; }
        .card { background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background-color: #2980b9; }
        input, select { padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
        .user-info { margin-top: 20px; display: none; }
        .form-group { margin-bottom: 15px; }
        pre { background-color: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
<h1>TSnessGYM API Interface</h1>

<!-- Liens vers les autres interfaces -->
<div style="text-align: center; margin-bottom: 20px;">
    <a href="index.html" style="margin: 0 10px;">Admin</a>
    <a href="index-user.html" style="margin: 0 10px;">User</a>
    <a href="index-owner.html" style="margin: 0 10px;">Owner</a>
</div>

<!-- Authentification -->
<div class="card">
    <h2>Authentification</h2>
    <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" value="tsnessgym2@yopmail.com">
    </div>
    <div class="form-group">
        <label for="password">Mot de passe:</label>
        <input type="password" id="password" value="tsnessgym">
    </div>
    <button id="login-btn">Se connecter</button>
    <div id="token-display" style="margin-top: 10px; display: none;">
        <h3>Token de session:</h3>
        <pre id="token-value"></pre>
    </div>
</div>

<!-- Profil utilisateur -->
<div class="card">
    <h2>Profil utilisateur</h2>
    <button id="get-me-btn">Récupérer mes informations</button>
    <div id="user-info" class="user-info">
        <h3>Informations utilisateur:</h3>
        <pre id="user-data"></pre>
    </div>
</div>

<!-- Utilisateurs CRUD -->
<div class="card">
    <h2>Utilisateurs</h2>
    <button id="get-users-btn">Lister tous les utilisateurs</button>
    <pre id="users-list"></pre>
    <h3>Désactiver un utilisateur</h3>
    <div class="form-group">
        <select id="disable-id"></select>
    </div>
    <button id="disable-user-btn">Désactiver</button>
    <h3>Supprimer un utilisateur</h3>
    <div class="form-group">
        <select id="delete-id"></select>
    </div>
    <button id="delete-user-btn">Supprimer</button>
</div>

<!-- Badges CRUD -->
<div class="card">
    <h2>Badges (CRUD)</h2>
    <button id="get-badges-btn">Lister tous les badges</button>
    <pre id="badges-list"></pre>
    <h3>Créer un badge</h3>
    <div class="form-group">
        <input type="text" id="new-badge-name" placeholder="Nom du badge">
        <input type="text" id="new-badge-desc" placeholder="Description">
        <input type="text" id="new-badge-rule" placeholder="Règle du badge">
    </div>
    <button id="create-badge-btn">Créer</button>
    <h3>Mettre à jour un badge</h3>
    <div class="form-group">
        <select id="update-badge-id"></select>
        <input type="text" id="update-badge-name" placeholder="Nouveau nom">
        <input type="text" id="update-badge-desc" placeholder="Nouvelle description">
    </div>
    <button id="update-badge-btn">Mettre à jour</button>
    <h3>Supprimer un badge</h3>
    <div class="form-group">
        <select id="delete-badge-id"></select>
    </div>
    <button id="delete-badge-btn">Supprimer</button>
</div>

<!-- Salles CRUD -->
<div class="card">
    <h2>Salles (CRUD)</h2>
    <button id="get-rooms-btn">Lister toutes les salles</button>
    <pre id="rooms-list"></pre>
    <h3>Créer une salle</h3>
    <div class="form-group">
        <input type="text" id="new-room-name" placeholder="Nom de la salle">
        <input type="text" id="new-room-location" placeholder="Emplacement">
        <input type="text" id="new-room-owner" placeholder="ID propriétaire">
        <input type="text" id="new-room-contact" placeholder="Contact">
        <input type="text" id="new-room-address" placeholder="Adresse">
        <input type="number" id="new-room-capacity" placeholder="Capacité">
    </div>
    <button id="create-room-btn">Créer</button>
    <h3>Mettre à jour une salle</h3>
    <div class="form-group">
        <input type="text" id="update-room-id" placeholder="ID salle">
        <input type="text" id="update-room-name" placeholder="Nouveau nom">
    </div>
    <button id="update-room-btn">Mettre à jour</button>
    <h3>Supprimer une salle</h3>
    <div class="form-group">
        <input type="text" id="delete-room-id" placeholder="ID salle">
    </div>
    <button id="delete-room-btn">Supprimer</button>
</div>

<!-- Challenges CRUD -->
<div class="card">
    <h2>Challenges (CRUD)</h2>
    <button id="get-challenges-btn">Lister tous les challenges</button>
    <pre id="challenges-list"></pre>
    <h3>Créer un challenge</h3>
    <div class="form-group">
        <input type="text" id="new-challenge-title" placeholder="Titre">
        <input type="text" id="new-challenge-desc" placeholder="Description">
        <input type="text" id="new-challenge-creator" placeholder="ID créateur">
        <input type="number" id="new-challenge-duration" placeholder="Durée (en minutes)">
    </div>
    <button id="create-challenge-btn">Créer</button>
    <h3>Mettre à jour un challenge</h3>
    <div class="form-group">
        <input type="text" id="update-challenge-id" placeholder="ID challenge">
        <input type="text" id="update-challenge-title" placeholder="Nouveau titre">
    </div>
    <button id="update-challenge-btn">Mettre à jour</button>
    <h3>Supprimer un challenge</h3>
    <div class="form-group">
        <input type="text" id="delete-challenge-id" placeholder="ID challenge">
    </div>
    <button id="delete-challenge-btn">Supprimer</button>
</div>

<!-- Exercices CRUD -->
<div class="card">
    <h2>Type d'exercices (CRUD)</h2>
    <button id="get-exercises-btn">Lister tous les exercices</button>
    <pre id="exercises-list"></pre>
    <h3>Créer un exercice</h3>
    <div class="form-group">
        <input type="text" id="new-exercise-name" placeholder="Nom de l'exercice">
        <input type="text" id="new-exercise-desc" placeholder="Description">
        <input type="text" id="new-exercise-muscles" placeholder="Muscles ciblés (séparés par des virgules)">
    </div>
    <button id="create-exercise-btn">Créer</button>
    <!-- Mettre à jour un exercice -->
    <h3>Mettre à jour un exercice</h3>
    <div class="form-group">
        <select id="update-exercise-id"></select>
        <input type="text" id="update-exercise-name" placeholder="Nouveau nom">
        <input type="text" id="update-exercise-desc" placeholder="Nouvelle description">
        <input type="text" id="update-exercise-muscles" placeholder="Nouveaux muscles (séparés par des virgules)">
    </div>
    <button id="update-exercise-btn">Mettre à jour</button>

    <!-- Supprimer un exercice -->
    <h3>Supprimer un exercice</h3>
    <div class="form-group">
        <select id="delete-exercise-id"></select>
    </div>
    <button id="delete-exercise-btn">Supprimer</button>
</div>

<!-- Statistiques d'entraînement CRUD -->
<div class="card">
    <h2>Stats d'entraînement (CRUD)</h2>
    <button id="get-stats-btn">Lister toutes les stats</button>
    <pre id="stats-list"></pre>
    <h3>Créer une stat</h3>
    <div class="form-group">
        <input type="text" id="new-stats-userId" placeholder="ID utilisateur">
        <input type="text" id="new-stats-challengeId" placeholder="ID challenge">
        <input type="number" id="new-stats-progress" placeholder="Progression (%)">
        <input type="number" id="new-stats-totalCalories" placeholder="Total calories">
    </div>
    <button id="create-stats-btn">Créer</button>
    <h3>Mettre à jour une stat</h3>
    <div class="form-group">
        <input type="text" id="update-stats-id" placeholder="ID stat">
        <input type="number" id="update-stats-progress" placeholder="Nouvelle progression (%)">
        <input type="number" id="update-stats-totalCalories" placeholder="Nouvelles calories">
    </div>
    <button id="update-stats-btn">Mettre à jour</button>
    <h3>Supprimer une stat</h3>
    <div class="form-group">
        <input type="text" id="delete-stats-id" placeholder="ID stat">
    </div>
    <button id="delete-stats-btn">Supprimer</button>
</div>

<script>
    let authToken = '';
    const API_BASE = 'http://localhost:3001';

    async function showApiAlert(res, successMsg, defaultErrorMsg) {
        if (res.ok) {
            alert(successMsg);
            return;
        }

        try {
            const errorData = await res.json();
            alert(errorData.message || defaultErrorMsg);
        } catch (error) {
            alert(defaultErrorMsg);
        }
    }

    // Auth
    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            if (!response.ok) {
                let data;
                try { data = await response.json(); } catch { data = {}; }
                throw new Error(data.message || `Erreur de connexion: ${response.status}`);
            }
            const data = await response.json();
authToken = data.token || data._id;
            document.getElementById('token-value').textContent = authToken;
            document.getElementById('token-display').style.display = 'block';
            alert('Connexion réussie!');
        } catch (error) {
            alert(`Erreur de connexion: ${error.message}`);
        }
        await populateUserSelects();
        await populateExerciseSelects();
        await populateBadgeSelects();
    });

    document.getElementById('get-me-btn').addEventListener('click', async () => {
        try {
            const response = await fetch(`${API_BASE}/auth/me`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (!response.ok) {
                let data;
                try { data = await response.json(); } catch { data = {}; }
                throw new Error(data.message || `Erreur: ${response.status}`);
            }
            const userData = await response.json();
            document.getElementById('user-data').textContent = JSON.stringify(userData, null, 2);
            document.getElementById('user-info').style.display = 'block';
        } catch (error) {
            alert(`Erreur: ${error.message}`);
        }
    });

    // Utilisateurs
    document.getElementById('get-users-btn').addEventListener('click', async () => {
        if (!authToken) {
            alert('Veuillez vous connecter d\'abord!');
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/users`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (res.ok) {
                const users = await res.json();
                document.getElementById('users-list').textContent = JSON.stringify(users, null, 2);
            } else {
                const errorData = await res.json();
                alert(errorData.message || `Erreur ${res.status}: Accès refusé`);
                document.getElementById('users-list').textContent = "Accès refusé: droits administrateur requis";
            }
        } catch (error) {
            alert(`Erreur: ${error.message}`);
            document.getElementById('users-list').textContent = "Erreur lors du chargement des utilisateurs";
        }
        await populateUserSelects();
    });

    async function populateBadgeSelects() {
        const res = await fetch(`${API_BASE}/badges`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!res.ok) return;
        const badges = await res.json();
        const updateSelect = document.getElementById('update-badge-id');
        const deleteSelect = document.getElementById('delete-badge-id');
        updateSelect.innerHTML = '';
        deleteSelect.innerHTML = '';
        badges.forEach(badge => {
            const optionText = `${badge._id} - ${badge.name}`;
            const opt1 = document.createElement('option');
            opt1.value = badge._id;
            opt1.textContent = optionText;
            updateSelect.appendChild(opt1);

            const opt2 = document.createElement('option');
            opt2.value = badge._id;
            opt2.textContent = optionText;
            deleteSelect.appendChild(opt2);
        });
    }

    async function populateExerciseSelects() {
        const res = await fetch(`${API_BASE}/exercises`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!res.ok) return;
        const exercises = await res.json();
        const updateSelect = document.getElementById('update-exercise-id');
        const deleteSelect = document.getElementById('delete-exercise-id');
        updateSelect.innerHTML = '';
        deleteSelect.innerHTML = '';
        exercises.forEach(ex => {
            const optionText = `${ex._id} - ${ex.name}`;
            const opt1 = document.createElement('option');
            opt1.value = ex._id;
            opt1.textContent = optionText;
            updateSelect.appendChild(opt1);

            const opt2 = document.createElement('option');
            opt2.value = ex._id;
            opt2.textContent = optionText;
            deleteSelect.appendChild(opt2);
        });
    }

    async function populateUserSelects() {
        if (!authToken) return;
        try {
            const res = await fetch(`${API_BASE}/users`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (!res.ok) return;
            const users = await res.json();
            const disableSelect = document.getElementById('disable-id');
            const deleteSelect = document.getElementById('delete-id');
            disableSelect.innerHTML = '';
            deleteSelect.innerHTML = '';
            users.forEach(user => {
                const optionText = `${user._id} - ${user.email} [${user.role}]`;
                const option1 = document.createElement('option');
                option1.value = user._id;
                option1.textContent = optionText;
                disableSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = user._id;
                option2.textContent = optionText;
                deleteSelect.appendChild(option2);
            });
        } catch {}
    }

    // Désactivation d'utilisateur
    document.getElementById('disable-user-btn').addEventListener('click', async () => {
        const id = document.getElementById('disable-id').value.trim();
        const res = await fetch(`${API_BASE}/users/disable/${id}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        await showApiAlert(res, 'Utilisateur désactivé', 'Erreur lors de la désactivation');
        await populateUserSelects();
    });

    // Suppression d'utilisateur
    document.getElementById('delete-user-btn').addEventListener('click', async () => {
        const id = document.getElementById('delete-id').value;

        const res = await fetch(`${API_BASE}/users/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        await showApiAlert(res, 'Utilisateur supprimé', 'Erreur lors de la suppression');
        await populateUserSelects();
    });

    // Badges
    document.getElementById('get-badges-btn').addEventListener('click', async () => {
        const res = await fetch(`${API_BASE}/badges`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const badges = await res.json();
        document.getElementById('badges-list').textContent = JSON.stringify(badges, null, 2);
    });

    document.getElementById('create-badge-btn').addEventListener('click', async () => {
        const name = document.getElementById('new-badge-name').value;
        const description = document.getElementById('new-badge-desc').value;
        const rule = document.getElementById('new-badge-rule').value;
        const res = await fetch(`${API_BASE}/badges`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ name, description, rule })
        });
        await showApiAlert(res, 'Badge créé', 'Erreur lors de la création');
        await populateBadgeSelects();
    });

    document.getElementById('update-badge-btn').addEventListener('click', async () => {
        const id = document.getElementById('update-badge-id').value.trim();
        const name = document.getElementById('update-badge-name').value;
        const description = document.getElementById('update-badge-desc').value;
        const res = await fetch(`${API_BASE}/badges/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ name, description })
        });
        await showApiAlert(res, 'Badge mis à jour', 'Erreur lors de la mise à jour');
        await populateBadgeSelects();
    });

    document.getElementById('delete-badge-btn').addEventListener('click', async () => {
        const id = document.getElementById('delete-badge-id').value.trim();
        const res = await fetch(`${API_BASE}/badges/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        await showApiAlert(res, 'Badge supprimé', 'Erreur lors de la suppression');
        await populateBadgeSelects();
    });

    // Salles
    document.getElementById('get-rooms-btn').addEventListener('click', async () => {
        const res = await fetch(`${API_BASE}/gym-rooms`);
        const rooms = await res.json();
        document.getElementById('rooms-list').textContent = JSON.stringify(rooms, null, 2);
    });
    document.getElementById('create-room-btn').addEventListener('click', async () => {
        const name = document.getElementById('new-room-name').value;
        const location = document.getElementById('new-room-location').value;
        const ownerId = document.getElementById('new-room-owner').value;
        const contact = document.getElementById('new-room-contact').value;
        const address = document.getElementById('new-room-address').value;
        const capacity = document.getElementById('new-room-capacity').value;
        const res = await fetch(`${API_BASE}/gym-rooms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, location, ownerId, contact, address, capacity })
        });
        await showApiAlert(res, 'Salle créée', 'Erreur lors de la création');
    });
    document.getElementById('update-room-btn').addEventListener('click', async () => {
        const id = document.getElementById('update-room-id').value;
        const name = document.getElementById('update-room-name').value;
        const res = await fetch(`${API_BASE}/gym-rooms/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        await showApiAlert(res, 'Salle mise à jour', 'Erreur lors de la mise à jour');
    });
    document.getElementById('delete-room-btn').addEventListener('click', async () => {
        const id = document.getElementById('delete-room-id').value;
        const res = await fetch(`${API_BASE}/gym-rooms/${id}`, { method: 'DELETE' });
        await showApiAlert(res, 'Salle supprimée', 'Erreur lors de la suppression');
    });

    // Challenges
    document.getElementById('get-challenges-btn').addEventListener('click', async () => {
        const res = await fetch(`${API_BASE}/challenges`);
        const challenges = await res.json();
        document.getElementById('challenges-list').textContent = JSON.stringify(challenges, null, 2);
    });
    document.getElementById('create-challenge-btn').addEventListener('click', async () => {
        const title = document.getElementById('new-challenge-title').value;
        const description = document.getElementById('new-challenge-desc').value;
        const creatorId = document.getElementById('new-challenge-creator').value;
        const duration = document.getElementById('new-challenge-duration').value;
        const res = await fetch(`${API_BASE}/challenges`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, creatorId, duration })
        });
        await showApiAlert(res, 'Challenge créé', 'Erreur lors de la création');
    });
    document.getElementById('update-challenge-btn').addEventListener('click', async () => {
        const id = document.getElementById('update-challenge-id').value;
        const title = document.getElementById('update-challenge-title').value;
        const res = await fetch(`${API_BASE}/challenges/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title })
        });
        await showApiAlert(res, 'Challenge mis à jour', 'Erreur lors de la mise à jour');
    });
    document.getElementById('delete-challenge-btn').addEventListener('click', async () => {
        const id = document.getElementById('delete-challenge-id').value;
        const res = await fetch(`${API_BASE}/challenges/${id}`, { method: 'DELETE' });
        await showApiAlert(res, 'Challenge supprimé', 'Erreur lors de la suppression');
    });

    // Lister les exercices
    document.getElementById('get-exercises-btn').addEventListener('click', async () => {
        const res = await fetch(`${API_BASE}/exercises`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const exercises = await res.json();
        document.getElementById('exercises-list').textContent = JSON.stringify(exercises, null, 2);
    });

    // Créer un exercice
    document.getElementById('create-exercise-btn').addEventListener('click', async () => {
        const name = document.getElementById('new-exercise-name').value;
        const description = document.getElementById('new-exercise-desc').value;
        const muscles = document.getElementById('new-exercise-muscles').value.split(',').map(m => m.trim());
        const res = await fetch(`${API_BASE}/exercises`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ name, description, muscles })
        });
        await showApiAlert(res, 'Exercice créé', 'Erreur lors de la création');
        await populateExerciseSelects();
    });

    // Mettre à jour un exercice
   document.getElementById('update-exercise-btn').addEventListener('click', async () => {
        const id = document.getElementById('update-exercise-id').value;
        const name = document.getElementById('update-exercise-name').value;
        const description = document.getElementById('update-exercise-desc').value;
        const muscles = document.getElementById('update-exercise-muscles').value
            .split(',')
            .map(m => m.trim())
            .filter(m => m);

        const res = await fetch(`${API_BASE}/exercises/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ name, description, muscles })
        });
        await showApiAlert(res, 'Exercice mis à jour', 'Erreur lors de la mise à jour');
        await populateExerciseSelects();
    });

    // Supprimer un exercice
    document.getElementById('delete-exercise-btn').addEventListener('click', async () => {
        const id = document.getElementById('delete-exercise-id').value;
        const res = await fetch(`${API_BASE}/exercises/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        await showApiAlert(res, 'Exercice supprimé', 'Erreur lors de la suppression');
        await populateExerciseSelects();
    });

    // Stats d'entraînement
    document.getElementById('get-stats-btn').addEventListener('click', async () => {
        const res = await fetch(`${API_BASE}/training-stats`);
        const stats = await res.json();
        document.getElementById('stats-list').textContent = JSON.stringify(stats, null, 2);
    });
    document.getElementById('create-stats-btn').addEventListener('click', async () => {
        const userId = document.getElementById('new-stats-userId').value;
        const challengeId = document.getElementById('new-stats-challengeId').value;
        const progress = document.getElementById('new-stats-progress').value;
        const totalCalories = document.getElementById('new-stats-totalCalories').value;
        const res = await fetch(`${API_BASE}/training-stats`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, challengeId, progress, totalCalories })
        });
        await showApiAlert(res, 'Stat créée', 'Erreur lors de la création');
    });
    document.getElementById('update-stats-btn').addEventListener('click', async () => {
        const id = document.getElementById('update-stats-id').value;
        const progress = document.getElementById('update-stats-progress').value;
        const totalCalories = document.getElementById('update-stats-totalCalories').value;
        const res = await fetch(`${API_BASE}/training-stats/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ progress, totalCalories })
        });
        await showApiAlert(res, 'Stat mise à jour', 'Erreur lors de la mise à jour');
    });
    document.getElementById('delete-stats-btn').addEventListener('click', async () => {
        const id = document.getElementById('delete-stats-id').value;
        const res = await fetch(`${API_BASE}/training-stats/${id}`, { method: 'DELETE' });
        await showApiAlert(res, 'Stat supprimée', 'Erreur lors de la suppression');
    });
</script>
</body>
</html>